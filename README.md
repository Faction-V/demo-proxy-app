
# Demo Proxy App

A FastAPI middleware proxy that sits between a frontend (React/Vue) and Capitol AI's backend services (platform-api, capitol-llm). It enables foreign user authentication, automatic source injection, and request transformation as part of the gofapi-to-platform-api migration (COM-22 / BE-955).

## Architecture

```
[React/Vue Frontend]  (localhost:5174)
        |
        v
[demo-proxy-app]      (localhost:8000)  <-- This repo
   |          |
   |          +--> [clj_postgres]  (source ID queries via SQLAlchemy)
   v
[platform-api]        (localhost:8811)
   |
   v
[capitol-llm]         (localhost:8003)
   |
   v
[socket-llm]          (WebSocket streaming)
```

**What it does:**

- Intercepts all `/api/{path}` requests and forwards them to platform-api
- Injects `X-Domain`, `X-API-Key`, and `X-User-ID` headers on every request
- Intercepts `POST /chat/async` requests to auto-inject source document IDs from the database (with download URLs)
- Strips `/v1/` prefix added by the React library
- Adds `X-Forwarded-Host` for correct WebSocket address generation

## Quick Start

### Prerequisites

- Docker and Docker Compose
- [Just](https://github.com/casey/just) command runner (recommended)
- Sibling repos checked out: `platform-api`, `clj-pg-wrapper`, `llm` (capitol-llm)
- Shared Docker network: `cap-multi-compose`

### Full Stack Setup

```bash
# Start all backend services (platform-api, clj-pg-wrapper, capitol-llm, proxy)
just start-services

# Create API key, seed prompts, configure .env
just setup-demo

# Run foreign user auth test suite
just test-foreign-auth

# Or do everything in one command
just demo-full
```

### Proxy-Only Setup

```bash
just build          # Build the Docker image
just start          # Start the proxy at localhost:8000
just setup-demo     # Create API key and configure .env
```

### Manual Setup

```bash
git clone https://github.com/Faction-V/demo-proxy-app
cd demo-proxy-app
cp .env.sample .env
docker-compose up -d
```

Then create an API key:

```bash
curl -X POST "http://localhost:8811/internal-api-keys/f6fffb00-8fbc-4ec4-8d6b-f0e01154a253?env=dev" \
  -H "Content-Type: application/json" \
  -d '{"name": "Demo Proxy Key", "description": "API key for demo proxy application"}'
```

Update `.env` with the returned key and restart: `docker-compose restart`.

## Configuration

Environment variables (`.env` file):

| Variable | Description | Default |
|----------|-------------|---------|
| `API_URL` | platform-api base URL | `http://platform_api/public` |
| `DOMAIN` | Value for `X-Domain` header | `https://aigrants.co/` |
| `API_KEY` | API key for `X-API-Key` header | (generated by `setup-demo`) |
| `DATABASE_URL` | PostgreSQL connection for source queries | `postgresql://postgres:postgres@localhost:5432/postgres` |

## Endpoints

### Proxy Catch-All

**`ANY /api/{path}`** - Forwards any request to `API_URL/{path}` with injected auth headers.

Special behavior for `POST /api/.../chat/async`:
1. Queries the database for the 10 most recent embedded sources
2. Injects `user_pre_processed_sources` (with download URLs) into the request body
3. Forwards the modified request to platform-api

### Forward Story

**`POST /forward-story`** - Forwards a story payload with custom headers (legacy endpoint).

### API Documentation

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## Just Commands

### Application Lifecycle

| Command | Description |
|---------|-------------|
| `just start` | Start the proxy container |
| `just stop` | Stop the proxy container |
| `just restart` | Restart the proxy container |
| `just build` | Build the Docker image |
| `just logs` | Tail application logs |
| `just status` | Show container status and config |
| `just clean` | Remove containers and volumes |
| `just config` | Print current `.env` values |
| `just check-env` | Validate environment configuration |

### Demo & Setup

| Command | Description |
|---------|-------------|
| `just setup` | Full setup: build + start + setup-demo |
| `just setup-demo` | Create API key, seed prompts, update `.env` |
| `just setup-full` | Full setup including React frontend |
| `just create-api-key` | Create a new API key (accepts `org_id`, `env`) |
| `just list-api-keys` | List API keys for an organization |
| `just update-api-key KEY` | Update API key in `.env` and restart |
| `just test` | Test proxy health endpoint |

### Multi-Service Orchestration

| Command | Description |
|---------|-------------|
| `just start-services` | Start platform-api, clj-pg-wrapper, capitol-llm, proxy |
| `just stop-services` | Stop all services |
| `just start-all` | Start all services + React frontend |
| `just demo-full` | Start services, setup demo, run auth tests |
| `just test-foreign-auth` | Run `test-foreign-user.sh` |

### Frontend

| Command | Description |
|---------|-------------|
| `just start-react` | Start React demo at localhost:5174 |
| `just start-vue` | Start Vue demo at localhost:5173 |

## Frontend Demos

### React Demo (`react-demo/`)

- URL: http://localhost:5174
- Start: `just start-react`
- Configured to proxy API calls through this app at localhost:8000

### Vue Demo (`vue-demo/`)

- URL: http://localhost:5173
- Start: `just start-vue`

## Foreign User Authentication

The proxy implements the "foreign user" pattern from clj-services (gofapi). Every proxied request includes:

- `X-API-Key` - Organization API key (from `.env`)
- `X-User-ID` - External user identifier (passed through from incoming request, or defaults to `"1"`)
- `X-Domain` - Organization domain (from `.env`)

platform-api uses these headers to create/lookup foreign users via clj-pg-wrapper's get-or-create pattern.

## Test Scripts

| Script | Purpose |
|--------|---------|
| `test-foreign-user.sh` | Tests foreign user auth with 4 different user IDs |
| `test-source-upload.sh` | Tests JSON source upload + story generation with sources |
| `test-websocket-upload.sh` | Tests WebSocket-based async source upload flow |
| `check-env.sh` | Validates environment variables are set correctly |

## Documentation

| File | Description |
|------|-------------|
| [GOFAPI_MIGRATION.md](GOFAPI_MIGRATION.md) | Endpoint migration tracker (gofapi to platform-api) |

## Related Repositories

| Repo | Branch | Role |
|------|--------|------|
| [demo-proxy-app](https://github.com/Faction-V/demo-proxy-app) | `BE-955-proxy-demo-app-poc` | This proxy middleware |
| [platform-api](https://github.com/Faction-V/platform-api) | `BE-955-proxy-demo-app-poc` | Backend API with gofapi-compatible endpoints |
| [clj-pg-wrapper](https://github.com/Faction-V/clj-pg-wrapper) | `BE-955-proxy-demo-app-poc` | Foreign user creation endpoint |
| [frontend](https://github.com/Faction-V/frontend) | `features-test-branch` | React library with WebSocket instrumentation |

## Jira

- **Epic:** [COM-21](https://capitolai.atlassian.net/browse/COM-21) - Deprecate clj-services for Politico / capitol.ai
- **Task:** [COM-22](https://capitolai.atlassian.net/browse/COM-22) - Proxy Demo App POC using platform-api
