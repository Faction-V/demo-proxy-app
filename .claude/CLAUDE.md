# Demo Proxy App

## Repository Overview

FastAPI middleware proxy that bridges frontend applications (React/Vue) to Capitol AI's backend services (platform-api, capitol-llm). Acts as a request transformation layer that injects authentication headers (`X-API-Key`, `X-User-ID`, `X-Domain`), strips API version prefixes, and enriches story generation requests with source documents.

Part of the foreign user authentication migration from Clojure gofapi to Python-based platform-api (Epic COM-21, Task BE-955).

## Web Framework

FastAPI + Uvicorn (Python 3.10)

## Architecture Overview

```
Frontend (React on :5174 / Vue on :5173)
    |
Demo Proxy App (:8000)          <-- this repo
    | [injects headers + sources]
Platform API (:8811)
    |
Capitol LLM (:8003) + CLJ PG Wrapper (:8400)
    |
PostgreSQL + S3 + Redis + Qdrant
```

### Directory Structure

```
app/
  main.py               # Core proxy logic (single file - routes, config, source injection)
  sample_source.txt     # Sample renewable energy document uploaded on startup
tests/
  conftest.py           # pytest fixtures (base_url, api_key, auth_headers, client)
  test_e2e.py           # 10 test classes, 25 tests (auth, endpoints, proxy behavior)
react-demo/             # React 18 + Vite + @capitol.ai/react (primary demo)
vue-demo/               # Vue 3 + Vite + @capitol.ai/vue (secondary demo)
demo/                   # Legacy React CRA demo (deprecated)
bin/
  push_to_ecr.sh        # Docker image push to AWS ECR
```

### Application Logic (`app/main.py`)

Single-file application with these concerns:

| Lines | Component | Purpose |
|-------|-----------|---------|
| 14-31 | Config | Environment variables loaded at module level |
| 34-91 | `upload_sample_source()` | Async startup task: uploads sample source with 30x retry |
| 94-123 | `get_source_for_injection()` | Reads persisted source ID for chat enrichment |
| 126-131 | Lifespan | FastAPI lifespan context manager for startup hook |
| 145-169 | `add_custom_headers()` | Injects `X-Domain`, `X-API-Key`, `X-User-ID` headers |
| 173-187 | `POST /forward-story` | Legacy endpoint for story forwarding |
| 191-286 | `ANY /api/{path}` | Catch-all proxy route with path stripping and source injection |

### Key Behaviors

- **Header injection**: Every proxied request receives `X-Domain`, `X-API-Key`, `X-User-ID`, `Accept: application/json`
- **Path stripping**: `/v1/` prefix removed (added by React library)
- **Source injection**: `POST /api/.../chat/async` requests are intercepted to inject `user_pre_processed_sources`
- **Startup task**: Sample renewable energy document auto-uploaded to platform-api on boot
- **Source persistence**: Source ID saved to `/app/source_id.json` for injection across requests

## Dependency Injection

No DI framework. Uses module-level `os.getenv()` calls and function-based architecture. No FastAPI `Depends()` or Kink DI patterns.

## Common Commands

All commands via `just` (justfile):

### Application Lifecycle
```bash
just start              # Start proxy container (:8000)
just stop               # Stop proxy
just restart            # Restart proxy
just build              # Build Docker image
just logs               # Tail container logs
just status             # Container status + config
just clean              # Remove containers/volumes
just check-env          # Validate environment vars
```

### Setup
```bash
just setup              # Full setup: build + start + setup-demo
just setup-demo         # Create API key, seed prompts, update .env
just setup-full         # Setup + start React frontend
just create-api-key     # Create new API key for org
just update-api-key KEY # Update .env with new key + restart
```

### Multi-Service Orchestration
```bash
just start-services     # Start platform-api, clj-pg-wrapper, capitol-llm, proxy
just stop-services      # Stop all services
just start-all          # Start services + React frontend
just demo-full          # Start services, setup, run auth tests
```

### Frontend
```bash
just start-react        # Start React demo on :5174
just start-vue          # Start Vue demo on :5173
```

### Testing
```bash
just test-e2e           # Run pytest suite (tests/test_e2e.py)
just test-foreign-auth  # Run foreign user auth test script
```

## Environment Configuration

Three variables in `.env` (see `.env.sample`):

| Variable | Purpose | Default |
|----------|---------|---------|
| `DOMAIN` | Organization domain for `X-Domain` header | `https://aigrants.co/` |
| `API_URL` | Platform API base URL | `http://platform_api/public` |
| `API_KEY` | API key for `X-API-Key` header | Generated by `just setup-demo` |

## Code Quality Conventions

- **Linting/Formatting**: No linter configured (no ruff, black, or flake8)
- **Type hints**: Not used in application code
- **Test framework**: pytest with session-scoped fixtures and `pytest-timeout`
- **Test structure**: Class-based test organization (10 classes in `test_e2e.py`)

## Git Conventions

**Branch naming**: `BE-955-proxy-demo-app-poc` (ticket-based)

**Commit format**: `[BE-955] verb(scope): description`
- Verbs: `feat`, `fix`, `chore`, `docs`, `refactor`
- Scopes: `proxy`, `react`, `vue`, `justfile`, `ci`
- Examples:
  - `[BE-955] feat(vue-demo): add vercel.json with API rewrites`
  - `[BE-955] fix(proxy): send only download_url and filename in source injection`

## Docker Configuration

- **Production**: `Dockerfile` (python:3.10-slim, no --reload)
- **Development**: `Dockerfile.dev` (python:3.10 full, uvicorn --reload)
- **Compose**: `docker-compose.yml` mounts `./app:/app` for hot reload
- **Network**: `cap-multi-compose` (external, shared with platform services)
- **Port**: 8000

## CI/CD Pipeline

### `ci-pipeline.yml` (any branch push)
1. Checkout
2. Generate Docker tag: tag name or `{branch-slug}-{short-sha}`
3. AWS ECR login
4. Build and push Docker image to ECR

### `push_to_ecr_latest_image.yml` (main branch only)
1. Checkout
2. Run `bin/push_to_ecr.sh` to push `latest` tag to ECR

**Registry**: `053376294935.dkr.ecr.us-east-1.amazonaws.com/demo-proxy-app`

## Frontend Demo Apps

| Demo | Framework | Port | Library | Status |
|------|-----------|------|---------|--------|
| `react-demo/` | React 18 + Vite | 5174 | `@capitol.ai/react` v0.0.124 | Active |
| `vue-demo/` | Vue 3 + Vite + TS | 5173 | `@capitol.ai/vue` v0.0.80 | Active |
| `demo/` | React 18 + CRA | 3000 | `@capitol.ai/react` v0.0.6 | Deprecated |

## Test Suite

Tests require a running proxy (`just start` first). Test classes in `tests/test_e2e.py`:

| Class | Tests | Coverage |
|-------|-------|----------|
| `TestAuth` | 6 | Header injection, override, caching |
| `TestUserEndpoints` | 2 | Token, membership |
| `TestOrgAndPrompts` | 2 | Organizations, prompts |
| `TestStoryplanConfig` | 2 | Config list, default |
| `TestStories` | 5 | Mini, plan-config, events |
| `TestGuardrails` | 1 | Prompt guardrail check |
| `TestProjects` | 1 | Project listing |
| `TestFeedback` | 1 | Thumbs feedback |
| `TestSourceUpload` | 2 | Sync upload, WebSocket |
| `TestProxyBehaviour` | 3 | Path stripping, 404 handling, gofapi alias |

## Migration Context

See `GOFAPI_MIGRATION.md` for endpoint migration status from Clojure gofapi to platform-api. Key pending items: Tako charts, credits, source listing, story versioning.

## Project-Specific Learnings

<!-- PRESERVED SECTION: START -->
<!-- Add project-specific notes, gotchas, and learnings below this line -->

<!-- PRESERVED SECTION: END -->
